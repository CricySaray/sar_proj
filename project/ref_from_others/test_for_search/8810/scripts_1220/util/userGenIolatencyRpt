####################################
#### genIolatencyfile
#### report clock latency of registers related with io port
####################################

## config the env
setAnalysisMode -checkType setup
reset_timing_derate
set_interactive_constraint_modes [all_constraint_modes -active]
set_propagated_clock [all_clocks]
reset_clock_latency [get_ports *]

#get clock ports
set clock_ports ""
foreach_in_collection _port [get_ports -filter {direction==in} *] {
	if { [sizeof_collection [get_property $_port clocks]]!=0} {
		append_to_collection clock_ports $_port
	}
}
#get latency info for every clock ports
array unset data
array set data ""
array unset latency
array set latency ""
array unset in2reg 
array set in2reg ""
array unset reg2out
array set regout ""
foreach_in_collection clock_port $clock_ports {
	set port_name [get_object_name $clock_port]
	puts "user_genIOlatency rpt reporting the pathes related to clock port of \"$port_name\"..."
	set create_clocks [get_property $clock_port clocks]
	set gen_clocks [get_property $create_clocks generated_clocks_extended]
	set all_clocks [add_to_collection $create_clocks $gen_clocks]
	set in2reg_paths [report_timing -from [all_inputs] -clock_to $all_clocks -check_type setup -max_paths 100000 -nworst 1 -path_type full_clock -net -collection]
	set reg2out_paths [report_timing -to [all_outputs] -clock_from $all_clocks -check_type setup -max_paths 100000 -nworst 1 -path_type full_clock -net -collection]
	puts "[sizeof_collection $in2reg_paths]"
	set in2reg($port_name) [sizeof_collection $in2reg_paths]
	set reg2out($port_name) [sizeof_collection $reg2out_paths]
	foreach_in_collection single_path $in2reg_paths {
		set clock_latency [get_property $single_path capturing_clock_latency]
		set path_clock [get_object_name [get_property $single_path capturing_clock]]
		set reg [get_object_name [get_cell -of_objects [get_property $single_path capturing_point]]]
		set port [get_object_name [get_property $single_path launching_point]]
		set path_group "in2reg"
		set view_name [get_property $single_path view_name]
		lappend data($port_name) [list $clock_latency $path_clock $port $reg $path_group $view_name]
		lappend latency($port_name) $clock_latency
	}
	foreach_in_collection single_path $reg2out_paths {
		set clock_latency [get_property $single_path launching_clock_latency]
		set path_clock [get_object_name [get_property $single_path launching_clock]]
		set reg [get_object_name [get_cell -of_objects [get_property $single_path launching_point]]]
		set port [get_object_name [get_property $single_path capturing_point]]
		set path_group "reg2out"
		set view_name [get_property $single_path view_name]
		lappend data($port_name) [list $clock_latency $path_clock $port $reg $path_group $view_name]
		lappend latency($port_name) $clock_latency
	}
}

##delet clock from clock_ports,that has no related path
set true_clock_ports ""
foreach_in_collection clock_port $clock_ports {
	set port_name [get_object_name $clock_port]
	if {[info exist latency($port_name)]} {
		lappend true_clock_ports $port_name
	}
}

##report summary latency info by clock ports
set file_sum "io_latency.summary"
set out_sum [open $file_sum w]
puts $out_sum "# Note:"
puts $out_sum "# 1. please check teh file of \"io_latency.check\" to make sure the environment of edi is ok"
puts $out_sum ""
puts $out_sum "------------------------------------------------------------------------"
puts $out_sum "[format "%-45s%-15s%-15s%-15s%-45s" clock_port max_latency min_latency average_latency skew ]"
puts $out_sum "------------------------------------------------------------------------"
foreach clock_port $true_clock_ports {
	set sum 0
	set path_sum [llength $latency($clock_port)]
	foreach _latency $latency($clock_port) {
		set sum [expr $sum + $_latency]
	}
	set average_latency [format %.3f [expr $sum/$path_sum]]
	set min_latency [lindex [lsort -decreasing -real $latency($clock_port)] end]
	set max_latency [lindex [lsort -decreasing -real $latency($clock_port)] 0]
	puts $out_sum "[format "%-45s%-15s%-15s%-15s%-45s" $clock_port $max_latency $min_latency $average_latency [expr $max_latency - $min_latency]]"
}
### add source clock latency
puts $out_sum "------------------------------------------------------------------------"
puts $out_sum "#add source latency"
puts $out_sum "[format "%-45s%-15s%-15s%-15s%-45s" clock_port max_latency min_latency average_latency skew]"
puts $out_sum "------------------------------------------------------------------------"
puts $out_sum "#early_rise"
foreach clock_port $true_clock_ports {
	set sum 0
	set path_sum [llength $latency($clock_port)]
	foreach _latency $latency($clock_port) {
		set sum [expr $sum + $_latency]
	}
	set early_rise [get_property [get_ports $clock_port] actual_latency_early_rise_max]
	set average_latency [format %.3f [expr $sum/$path_sum ]]
	set min_latency [lindex [lsort -decreasing -real $latency($clock_port)] end]
	set max_latency [lindex [lsort -decreasing -real $latency($clock_port)] 0]
	puts $out_sum "[format "%-45s%-15s%-15s%-15s%-45s" $clock_port [expr $max_latency - $early_rise] [expr $min_latency - $early_rise]  [expr $average_latency - $early_rise] [expr $max_latency - $min_latency]]"
}
puts $out_sum "#early fall"
foreach clock_port $true_clock_ports {
	set sum 0
	set path_sum [llength $latency($clock_port)]
	foreach _latency $latency($clock_port) {
		set sum [expr $sum + $_latency]
	}
	set early_fall [get_property [get_ports $clock_port] actual_latency_early_fall_max]
	set average_latency [format %.3f [expr $sum/$path_sum ]]
	set min_latency [lindex [lsort -decreasing -real $latency($clock_port)] end]
	set max_latency [lindex [lsort -decreasing -real $latency($clock_port)] 0]
	puts $out_sum "[format "%-45s%-15s%-15s%-15s%-45s" $clock_port [expr $max_latency - $early_fall] [expr $min_latency - $early_fall]  [expr $average_latency - $early_fall] [expr $max_latency - $min_latency]]"
}
close $out_sum

#report detail latency info by clock ports
set file_rpt "io_latency.rpt"
set out_rpt [open $file_rpt w]
foreach clock_port $true_clock_ports {
	foreach _path [lsort -decreasing -real -index 0 $data($clock_port)] {
		puts $out_rpt "$clock_port\t[join $_path "\t"]"
	}
}

close $out_rpt
####report the info of design for check
#
set file_check "io_latency.check"
set out_ck [open $file_check w]
puts $out_ck ""
puts $out_ck "******************** the active analysis view for setup ***************"
puts $out_ck "#1.set  the analysis view for setup as \"func_wc_cworst scan_wc_cworst bist_wc_cwost\"!"
puts $out_ck "         [all_setup_analysis_views]"
puts $out_ck "\n"
puts $out_ck "***** the total number of path related to io forevery clock port *********"
puts $out_ck "#1,if the num is equal to 1000,please set a large number for option of \"-max_points\"  in script!"
puts $out_ck [format "%-45s%-15s%-15s" clock_port in2reg reg2out]
puts $out_ck "----------------------------------------------------------------------------"

foreach clock_port $true_clock_ports {
	puts $out_ck [format "%-45s%-15s%-15s" $clock_port $in2reg($clock_port) $reg2out($clock_port)]
}
puts $out_ck "\n"
puts $out_ck "*****the clock latency forevery clock port *********"
puts $out_ck "#1 make sure th below clock latency is 0"
	puts $out_ck [format "%-45s%-15s%-15s%-15s%-15s" clock_port early_rise late_rise early_fall late_fall]
foreach clock_port $true_clock_ports {
	set early_rise [get_property [get_ports $clock_port] actual_latency_early_rise_max]
	set late_rise [get_property [get_ports $clock_port] actual_latency_late_rise_max]
	set early_fall [get_property [get_ports $clock_port] actual_latency_early_fall_max]
	set late_fall [get_property [get_ports $clock_port] actual_latency_late_fall_max]
	puts $out_ck [format "%-45s%-15s%-15s%-15s%-15s" $clock_port $early_rise $late_rise $early_fall $late_fall]
}
close $out_ck
