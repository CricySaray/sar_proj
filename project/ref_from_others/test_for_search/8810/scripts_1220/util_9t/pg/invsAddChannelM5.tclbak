proc invsAddChannelM5 {} {
 	global vars
	set block_shapes [dbShape [dbget [dbGet top.insts.cell.subClass block -p2].box]
	set shapes [dbShape [dbget [dbGet top.insts.cell.subClass block -p2].box] SIZE 15] SIZE -15 -output polygon]
	set all_mem_shapes [dbShape [dbShape [dbget [dbGet top.insts.cell.subClass block -p2].box SIZEY 15] SIZEY -15 -output polygon]
	set all_mem_shapes [dbShape [dbShape [dbget $all_mem_shapes SIZEX 1.2] SIZEX -1.2 -output polygon]
	set channel_shapes [dbShape $shapes ANDNOT $all_mem_shapes SIZEY 0 -output polygon]
	set boundary_left_cells_shapes [dbShape [dbget [dbget top.insts.cell.name BOUNDARY_LEFBWP35P140 -p2].boxes] -output polygon]
	set boundary_cells_shapes [dbShape [dbShape [dbget [dbGet top.insts.cell.name BOUNDARY_RIGHTBWP35P140 -p2].boxes] -output polygon] OR $boundary_left_cells_shapes -output polygon]
	set channel_boundary_cells_shapes [dbShape $channel_shapes AND $boundary_cells_shapes -output polygon]
	set channel_boundary_left_cells_shapes [dbShape $channel_shapes AND $boundary_left_cells_shapes -output polygon]
	set channel_boundary_left_cells_shapes_size [dbShape [dbShape $channel_boundary_left_cells_shapes SIZEY 15] SIZEY -15 -ouput polygon]
	set boundary_left_cells_boxes [dbShape $boundary_left_cells_shapes -output rect]
	set boundary_cells_boxes [dbShape $boundary_cells_shapes -output rect]
	
	#get all domain shapes
	set vars(power_domains) [userGetPowerDomains]

	set vars(GND) [dbPowerDomainGNet [lindex $vars(power_domains) 0]]
	set shut_domain_shapes_all {0 0 0 0}
	foreach domain $vars(power_domains) {
		if {[dbget [dbget top.pds.group.name $domain -p2].isDefault] ==1} {
			set vars(AON_PWR) [dbPowerDomainPNet [dbGetPowerDomainByName $domain]]
		} else {
			deselectAll
			selectObject Group $domain
			set ${domain}_shapes [dbShape [dbget selected.boxes] -output polygon]
			set shut_domain_shapes_all [dbShape [set ${domain}_shapes] OR $shut_domain_shapes_all  -output polygon]
		}
	}
	deselectAll
	set aon_domain_shapes_all [dbShape [dbget top.flan.boxes] ANDNOT $shut_domain_shapes_all -output polygon]

	##get boxes used for domain boundary channel
	foreach domain $vars(power_domains) {
		set ${domain}_boxes ""
		if {[dbget [dbget top.pds.group.name $domain -p2].isDefault] ==1} {
			set shape1 $aon_domain_shapes_all
		} else {
			set shape1 [set ${domain}_shapes]
		}
		foreach box $boundary_left_cells_boxes {
			set or_poly [dbshape [dbshape [dbshape $box -output polygon] SIZEX 15 -output polygon] OR $shape1 -output polygon]
			set and_poly [dbshape [dbshape [dbshape $box -output polygon] -output polygon] AND $shape1 -output polygon]
			set and_mem_poly [dbshape [dbshape $block_shapes SIZEX 10] AND [dbshape $box -output polygon] -output polygon]
			if {$or_poly != $shape1 && $and_poly != "" && $and_mem_poly != ""} {
				lappend ${domain}_boxes $box
			}
		}
	}

	###get boundray cells box for domain bourndary channel
	foreach domain $vars(power_domains) {
		set ${domain}_boundary_newadded_boxes ""
		if {[dbget [dbget top.pds.group.name $domain -p2].isDefault] ==1} {
			set shape1 $aon_domain_shapes_all
		} else {
			set shape1 [set ${domain}_shapes]
		}
		foreach box $boundary_cells_boxes {
			set or_poly [dbshape [dbshape [dbshape $box -output polygon] SIZEX 15 -output polygon] OR $shape1 -output polygon]
			set and_poly [dbshape [dbshape [dbshape $box -output polygon] -output polygon] AND $shape1 -output polygon]
			set and_mem_poly [dbshape [dbshape $block_shapes SIZEX 12] AND [dbshape $box -output polygon] -output polygon]
			if {$or_poly != $shape1 && $and_poly != "" && $and_mem_poly != ""} {
				lappend ${domain}_boundary_newadded_boxes $box
			}
		}
	}
	# add m5 on boundary cells
	foreach domain $vars(power_domains) {
		if {[dbget [dbget top.pds.group.name $domain -p2].isDefault] ==1} {
			set vars(PWR) $vars(AON_PWR)
			set ${domain}_channel_boundary_cells_shapes [dbshape $aon_domain_shapes_all AND $channel_boundary_cells_shapes -output rect]
		} else {
			set vars(PWR) [regsub $vars(AON_PWR) [dbPowerDomainPNet $domain] ""]
			set ${domain}_channel_boundary_cells_shapes [dbshape [set ${domain}_shapes] AND $channel_boundary_cells_shapes -output rect]
		}
		set ${domain}_channel_boundary_cells_boxes [dbshape [set ${domain}_channel_boundary_cells_shapes] OR [set ${domain}_boundary_newadded_boxes] -output rect]
		setEdit -drc_on 1 -create_via_on_pin 0 -extend_end_wires 0 -extend_start_wires 0 -layer M5 -nets $vars(PWR) -force_special 1 -create_crossover_vias 0 \
			-shape RING -spacing 0.08 -subclass mem_ring -use_via_gen 0 -width 0.16 -layer_horizontal M5 -layer_vertical M5  -width_vertical 0.16 -width_horizontal 0.16
		foreach box [set ${domain}_channel_boundary_cells_boxes] {
			set lx [lindex $box 0]
			set ly [lindex $box 1]
			set rx [lindex $box 2]
			set ry [lindex $box 3]
			editAddRoute [expr $lx + 0.08] $ly
			editCommitRoute [expr $lx + 0.08] $ry
		}
		setEdit -drc_on 1 -create_via_on_pin 0 -extend_end_wires 0 -extend_start_wires 0 -layer M5 -nets $vars(GND) -force_special 1 -create_crossover_vias 0 \
			-shape RING -spacing 0.08 -subclass mem_ring -use_via_gen 0 -width 0.16 -layer_horizontal M5 -layer_vertical M5  -width_vertical 0.16 -width_horizontal 0.16
		foreach box [set ${domain}_channel_boundary_cells_boxes] {
			set lx [lindex $box 0]
			set ly [lindex $box 1]
			set rx [lindex $box 2]
			set ry [lindex $box 3]
			editAddRoute [expr $lx + 0.08 + 0.16 + 0.08] $ly
			editCommitRoute [expr $lx + 0.08 + 0.16 + 0.08] $ry
		}
	}
			
	# add m5 on channel for channel power switch			
	foreach domain $vars(power_domains) {
		if {[dbget [dbget top.pds.group.name $domain -p2].isDefault] ==1} {
			set vars(PWR) $vars(AON_PWR)
			set ${domain}_channel_boundary_cells_shapes [dbshape $aon_domain_shapes_all AND $channel_boundary_left_cells_shapes_size -output rect]
		} else {
			set vars(PWR) [regsub $vars(AON_PWR) [dbPowerDomainPNet $domain] ""]
			set ${domain}_channel_boundary_cells_shapes [dbshape [set ${domain}_shapes] AND $channel_boundary_left_cells_shapes_size -output rect]
		}
		if {[dbget [dbget top.pds.group.name $domain -p2].isDefault] ==1} {
			setEdit -drc_on 1 -create_via_on_pin 0 -extend_end_wires 0 -extend_start_wires 0 -layer M5 -nets $vars(PWR) -force_special 1 -create_crossover_vias 0 \
				-shape RING -spacing 0.13 -subclass mem_ring -use_via_gen 0 -width 0.5 -layer_horizontal M5 -layer_vertical M5  -width_vertical 0.5 -width_horizontal 0.5
			foreach box [set ${domain}_channel_boundary_cells_shapes] {
				set lx [lindex $box 0]
				set ly [lindex $box 1]
				set rx [lindex $box 2]
				set ry [lindex $box 3]
				set new_box "$lx $ly [expr $rx + 6] $ry"
				set and_poly [dbShape $all_mem_shapes AND $new_box -output polygon]
				if { $and_poly ==""} {
					editAddRoute [expr $rx + $vars(m5channel_pffset)] $ly
					editCommitRoute [expr $rx + $vars(m5channel_pffset)] $ry
					editAddRoute [expr $rx + $vars(m5channel_pffset) + 0.5*3 + 0.13*3] $ly
					editCommitRoute [expr $rx + $vars(m5channel_pffset) + 0.5*3 + 0.13*3] $ry
				}
			}
			if {[set ${domain}_boxes] !=""} {
				foreach box [set ${domain}_boxes] {
					set lx [lindex $box 0]
					set ly [lindex $box 1]
					set rx [lindex $box 2]
					set ry [lindex $box 3]
					set new_box "$lx $ly [expr $rx + 6] $ry"
					set and_poly [dbShape $all_mem_shapes AND $new_box -output polygon]
				if { $and_poly ==""} {
					editAddRoute [expr $rx + $vars(m5channel_pffset)] $ly
					editCommitRoute [expr $rx + $vars(m5channel_pffset)] $ry
					editAddRoute [expr $rx + $vars(m5channel_pffset) + 0.5*3 + 0.13*3] $ly
					editCommitRoute [expr $rx + $vars(m5channel_pffset) + 0.5*3 + 0.13*3] $ry
				}
			}
		}
		setEdit -drc_on 1 -create_via_on_pin 0 -extend_end_wires 0 -extend_start_wires 0 -layer M5 -nets $vars(GND) -force_special 1 -create_crossover_vias 0 \
				-shape RING -spacing 0.13 -subclass mem_ring -use_via_gen 0 -width 0.5 -layer_horizontal M5 -layer_vertical M5  -width_vertical 0.5 -width_horizontal 0.5
		foreach box [set ${domain}_channel_boundary_cells_shapes] {
			set lx [lindex $box 0]
			set ly [lindex $box 1]
			set rx [lindex $box 2]
			set ry [lindex $box 3]
			set new_box "$lx $ly [expr $rx + 6] $ry"
			set and_poly [dbShape $all_mem_shapes AND $new_box -output polygon]
			if { $and_poly ==""} {
				editAddRoute [expr $rx + $vars(m5channel_pffset) + 0.5 + 0.13] $ly
				editCommitRoute [expr $rx + $vars(m5channel_pffset) + 0.5 + 0.13] $ry
				editAddRoute [expr $rx + $vars(m5channel_pffset) + 0.5*2 + 0.13*2] $ly
				editCommitRoute [expr $rx + $vars(m5channel_pffset) + 0.5*2 + 0.13*2] $ry
			}
		}
		if {[set ${domain}_boxes] !=""} {
			foreach box [set ${domain}_boxes] {
				set lx [lindex $box 0]
				set ly [lindex $box 1]
				set rx [lindex $box 2]
				set ry [lindex $box 3]
				set new_box "$lx $ly [expr $rx + 6] $ry"
				set and_poly [dbShape $all_mem_shapes AND $new_box -output polygon]
				if { $and_poly ==""} {
					editAddRoute [expr $rx + $vars(m5channel_pffset) + 0.5 + 0.13] $ly
					editCommitRoute [expr $rx + $vars(m5channel_pffset) + 0.5 + 0.13] $ry
					editAddRoute [expr $rx + $vars(m5channel_pffset) + 0.5*2 + 0.13*2] $ly
					editCommitRoute [expr $rx + $vars(m5channel_pffset) + 0.5*2 + 0.13*2] $ry
				}
			}
		}
	}
	uiSetTool select
	setEdit -reset
	}
}
